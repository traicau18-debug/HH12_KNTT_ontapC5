<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tr√≤ ch∆°i h·ªçc p·∫≠p - Pin ƒêi·ªán &amp; ƒêi·ªán Ph√¢n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Quicksand', sans-serif;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.4); }
      50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8); }
    }
    
    @keyframes bounce-in {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes slide-up {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    @keyframes timer-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .animate-bounce-in { animation: bounce-in 0.6s ease-out; }
    .animate-slide-up { animation: slide-up 0.5s ease-out; }
    .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .animate-shake { animation: shake 0.5s ease-in-out; }
    .animate-timer-pulse { animation: timer-pulse 0.5s ease-in-out; }
    
    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      animation: confetti 1s ease-out forwards;
    }
    
    .option-btn {
      transition: all 0.3s ease;
    }
    
    .option-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
    }
    
    .progress-fill {
      transition: width 0.5s ease;
    }
    
    .drag-item {
      cursor: grab;
      transition: all 0.2s ease;
    }
    
    .drag-item:active {
      cursor: grabbing;
    }
    
    .drop-zone {
      transition: all 0.3s ease;
    }
    
    .drop-zone.drag-over {
      background-color: rgba(99, 102, 241, 0.2);
      border-color: #6366f1;
    }
    
    .timer-warning {
      color: #ef4444;
      animation: timer-pulse 0.5s ease-in-out infinite;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full m-0 p-0 overflow-auto">
  <div id="app" class="min-h-full w-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500"><!-- Start Screen -->
   <div id="start-screen" class="min-h-full flex items-center justify-center p-4">
    <div class="glass-effect rounded-3xl p-8 max-w-lg w-full text-center animate-bounce-in shadow-2xl">
     <div class="text-6xl mb-4">
      ‚ö°üîã
     </div>
     <h1 id="main-title" class="text-3xl font-bold text-indigo-700 mb-2">PIN ƒêI·ªÜN &amp; ƒêI·ªÜN PH√ÇN</h1>
     <p class="text-purple-600 mb-2">√în t·∫≠p ch∆∞∆°ng 5</p>
     <p id="teacher-credit" class="text-sm text-gray-500 mb-6">Thi·∫øt k·∫ø: <span class="font-semibold">Nguy·ªÖn M·∫°nh H∆∞ng</span></p>
     <div class="bg-indigo-50 rounded-2xl p-4 mb-6">
      <div class="mb-4"><label class="block text-left text-indigo-700 font-semibold mb-2">üë§ H·ªç v√† t√™n:</label> <input type="text" id="student-name" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n..." class="w-full px-4 py-3 rounded-xl border-2 border-indigo-200 focus:border-indigo-500 focus:outline-none transition">
      </div>
      <div><label class="block text-left text-indigo-700 font-semibold mb-2">üè´ L·ªõp:</label> <input type="text" id="student-class" placeholder="V√≠ d·ª•: 11A1..." class="w-full px-4 py-3 rounded-xl border-2 border-indigo-200 focus:border-indigo-500 focus:outline-none transition">
      </div>
     </div>
     <div class="bg-yellow-50 rounded-xl p-4 mb-6 text-left">
      <h3 class="font-bold text-yellow-700 mb-2">üìã H∆∞·ªõng d·∫´n:</h3>
      <ul class="text-sm text-yellow-800 space-y-1">
       <li>‚Ä¢ 20 c√¢u h·ªèi - T·ªïng ƒëi·ªÉm: 100</li>
       <li>‚Ä¢ Th·ªùi gian: 15s (Nh·∫≠n bi·∫øt), 30s (Th√¥ng hi·ªÉu), 120s (V·∫≠n d·ª•ng)</li>
       <li>‚Ä¢ Tr·∫£ l·ªùi ƒë√∫ng: +5 ƒëi·ªÉm/c√¢u</li>
       <li>‚Ä¢ C√≥ ph·∫£n h·ªìi ngay sau m·ªói c√¢u</li>
      </ul>
     </div><button id="start-btn" onclick="startGame()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold text-xl rounded-2xl hover:from-indigo-700 hover:to-purple-700 transition transform hover:scale-105 shadow-lg"> üöÄ B·∫ÆT ƒê·∫¶U CH∆†I </button> <button onclick="showResults()" class="w-full mt-4 py-3 bg-white border-2 border-indigo-300 text-indigo-600 font-semibold rounded-2xl hover:bg-indigo-50 transition"> üìä Xem k·∫øt qu·∫£ h·ªçc sinh </button>
    </div>
   </div><!-- Game Screen -->
   <div id="game-screen" class="min-h-full p-4 hidden">
    <div class="max-w-3xl mx-auto"><!-- Header -->
     <div class="glass-effect rounded-2xl p-4 mb-4 shadow-lg">
      <div class="flex justify-between items-center mb-3">
       <div class="flex items-center gap-3"><span class="text-2xl">‚ö°</span> <span id="player-name" class="font-bold text-indigo-700"></span>
       </div>
       <div class="flex items-center gap-4">
        <div class="bg-yellow-100 px-4 py-2 rounded-full"><span class="text-yellow-700 font-bold">üèÜ <span id="current-score">0</span>/100</span>
        </div>
        <div id="timer-display" class="bg-indigo-100 px-4 py-2 rounded-full"><span class="text-indigo-700 font-bold">‚è±Ô∏è <span id="timer">30</span>s</span>
        </div>
       </div>
      </div><!-- Progress Bar -->
      <div class="relative">
       <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
        <div id="progress-bar" class="progress-fill h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full" style="width: 0%"></div>
       </div><span id="progress-text" class="absolute right-0 -top-6 text-sm text-indigo-600 font-semibold">C√¢u 1/20</span>
      </div>
     </div><!-- Question Card -->
     <div id="question-card" class="glass-effect rounded-3xl p-6 shadow-xl animate-slide-up">
      <div class="flex items-center gap-2 mb-4"><span id="difficulty-badge" class="px-3 py-1 rounded-full text-sm font-semibold"></span> <span id="question-type-badge" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold"></span>
      </div>
      <h2 id="question-text" class="text-xl font-bold text-gray-800 mb-6"></h2>
      <div id="options-container" class="space-y-3"></div><!-- Drag Drop Container -->
      <div id="drag-drop-container" class="hidden">
       <div id="drag-items" class="flex flex-wrap gap-3 mb-6 p-4 bg-gray-50 rounded-xl"></div>
       <div id="drop-zones" class="space-y-3"></div><button onclick="submitDragDrop()" class="mt-4 w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition"> ‚úì X√°c nh·∫≠n ƒë√°p √°n </button>
      </div>
     </div><!-- Feedback Modal -->
     <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div id="feedback-content" class="glass-effect rounded-3xl p-8 max-w-md w-full text-center animate-bounce-in">
       <div id="feedback-icon" class="text-6xl mb-4"></div>
       <h3 id="feedback-title" class="text-2xl font-bold mb-4"></h3>
       <p id="feedback-text" class="text-gray-700 mb-6"></p><button onclick="nextQuestion()" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition"> Ti·∫øp t·ª•c ‚ûú </button>
      </div>
     </div>
    </div>
   </div><!-- Result Screen -->
   <div id="result-screen" class="min-h-full flex items-center justify-center p-4 hidden">
    <div class="glass-effect rounded-3xl p-8 max-w-lg w-full text-center animate-bounce-in shadow-2xl">
     <div id="result-confetti" class="relative"></div>
     <div id="result-icon" class="text-7xl mb-4"></div>
     <h2 id="result-title" class="text-3xl font-bold mb-2"></h2>
     <p id="result-name" class="text-lg text-gray-600 mb-4"></p>
     <div class="bg-gradient-to-r from-indigo-100 to-purple-100 rounded-2xl p-6 mb-6">
      <div class="text-5xl font-bold text-indigo-700 mb-2">
       <span id="final-score">0</span>/100
      </div>
      <p class="text-gray-600">ƒêi·ªÉm s·ªë c·ªßa b·∫°n</p>
     </div>
     <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="bg-green-50 rounded-xl p-4">
       <div class="text-2xl font-bold text-green-600" id="correct-count">
        0
       </div>
       <p class="text-sm text-green-700">C√¢u ƒë√∫ng ‚úì</p>
      </div>
      <div class="bg-red-50 rounded-xl p-4">
       <div class="text-2xl font-bold text-red-600" id="wrong-count">
        0
       </div>
       <p class="text-sm text-red-700">C√¢u sai ‚úó</p>
      </div>
     </div>
     <p id="result-message" class="text-gray-700 mb-6"></p><button onclick="restartGame()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold text-xl rounded-2xl hover:from-indigo-700 hover:to-purple-700 transition transform hover:scale-105 shadow-lg"> üîÑ Ch∆°i l·∫°i </button> <button onclick="goHome()" class="w-full mt-3 py-3 bg-white border-2 border-indigo-300 text-indigo-600 font-semibold rounded-2xl hover:bg-indigo-50 transition"> üè† V·ªÅ trang ch·ªß </button>
    </div>
   </div><!-- Teacher Results Screen -->
   <div id="teacher-screen" class="min-h-full p-4 hidden">
    <div class="max-w-4xl mx-auto">
     <div class="glass-effect rounded-3xl p-6 shadow-xl">
      <div class="flex justify-between items-center mb-6">
       <h2 class="text-2xl font-bold text-indigo-700">üìä K·∫øt qu·∫£ h·ªçc sinh</h2>
       <div class="flex gap-3"><button onclick="downloadResults()" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition flex items-center gap-2"> üì• T·∫£i xu·ªëng CSV </button> <button onclick="goHome()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition"> ‚Üê Quay l·∫°i </button>
       </div>
      </div>
      <div id="results-stats" class="grid grid-cols-3 gap-4 mb-6">
       <div class="bg-indigo-50 rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-indigo-600" id="total-students">
         0
        </div>
        <p class="text-indigo-700">T·ªïng h·ªçc sinh</p>
       </div>
       <div class="bg-green-50 rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-green-600" id="avg-score">
         0
        </div>
        <p class="text-green-700">ƒêi·ªÉm trung b√¨nh</p>
       </div>
       <div class="bg-purple-50 rounded-xl p-4 text-center">
        <div class="text-3xl font-bold text-purple-600" id="highest-score">
         0
        </div>
        <p class="text-purple-700">ƒêi·ªÉm cao nh·∫•t</p>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="bg-indigo-100">
          <th class="px-4 py-3 text-left rounded-tl-xl">STT</th>
          <th class="px-4 py-3 text-left">H·ªç v√† t√™n</th>
          <th class="px-4 py-3 text-left">L·ªõp</th>
          <th class="px-4 py-3 text-center">ƒêi·ªÉm</th>
          <th class="px-4 py-3 text-center">ƒê√∫ng/T·ªïng</th>
          <th class="px-4 py-3 text-left rounded-tr-xl">Th·ªùi gian</th>
         </tr>
        </thead>
        <tbody id="results-table">
         <tr>
          <td colspan="6" class="px-4 py-8 text-center text-gray-500">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Questions Database
    const allQuestions = [
      // NH·∫¨N BI·∫æT (8 c√¢u) - 15 gi√¢y
      {
        id: 1,
        type: 'multiple',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'Pin ƒëi·ªán h√≥a (pin Galvani) l√† thi·∫øt b·ªã chuy·ªÉn h√≥a nƒÉng l∆∞·ª£ng n√†o th√†nh ƒëi·ªán nƒÉng?',
        options: ['H√≥a nƒÉng', 'Nhi·ªát nƒÉng', 'Quang nƒÉng', 'C∆° nƒÉng'],
        correct: 0,
        explanation: 'Pin ƒëi·ªán h√≥a chuy·ªÉn h√≥a nƒÉng l∆∞·ª£ng t·ª´ ph·∫£n ·ª©ng oxi h√≥a - kh·ª≠ (h√≥a nƒÉng) th√†nh ƒëi·ªán nƒÉng.'
      },
      {
        id: 2,
        type: 'multiple',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'Trong pin Galvani, ƒëi·ªán c·ª±c n√†o x·∫£y ra qu√° tr√¨nh oxi h√≥a?',
        options: ['Anode', 'Cathode', 'C·∫£ hai ƒëi·ªán c·ª±c', 'Kh√¥ng ƒëi·ªán c·ª±c n√†o'],
        correct: 0,
        explanation: 'T·∫°i anode (c·ª±c √¢m) x·∫£y ra qu√° tr√¨nh oxi h√≥a - kim lo·∫°i nh∆∞·ªùng electron.'
      },
      {
        id: 3,
        type: 'multiple',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'Trong pin Galvani, electron di chuy·ªÉn trong m·∫°ch ngo√†i theo chi·ªÅu n√†o?',
        options: ['T·ª´ anode sang cathode', 'T·ª´ cathode sang anode', 'Di chuy·ªÉn qua l·∫°i', 'Kh√¥ng di chuy·ªÉn'],
        correct: 0,
        explanation: 'Electron di chuy·ªÉn t·ª´ anode (n∆°i nh∆∞·ªùng e‚Åª) sang cathode (n∆°i nh·∫≠n e‚Åª) qua d√¢y d·∫´n.'
      },
      {
        id: 4,
        type: 'true-false',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'Cathode trong pin ƒëi·ªán h√≥a l√† n∆°i x·∫£y ra qu√° tr√¨nh kh·ª≠.',
        options: ['ƒê√∫ng', 'Sai'],
        correct: 0,
        explanation: 'ƒê√∫ng! T·∫°i cathode (c·ª±c d∆∞∆°ng), ion kim lo·∫°i nh·∫≠n electron v√† b·ªã kh·ª≠ th√†nh kim lo·∫°i.'
      },
      {
        id: 5,
        type: 'multiple',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'C·∫ßu mu·ªëi trong pin Galvani c√≥ t√°c d·ª•ng g√¨?',
        options: ['D·∫´n ion gi·ªØa hai dung d·ªãch', 'D·∫´n electron', 'T·∫°o ph·∫£n ·ª©ng h√≥a h·ªçc', 'L√†m tƒÉng ƒëi·ªán √°p'],
        correct: 0,
        explanation: 'C·∫ßu mu·ªëi cho ph√©p ion di chuy·ªÉn gi·ªØa hai n·ª≠a pin, duy tr√¨ s·ª± trung h√≤a ƒëi·ªán t√≠ch.'
      },
      {
        id: 6,
        type: 'multiple',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'Trong ƒëi·ªán ph√¢n dung d·ªãch, t·∫°i cathode x·∫£y ra qu√° tr√¨nh g√¨?',
        options: ['Kh·ª≠', 'Oxi h√≥a', 'C·∫£ hai', 'Kh√¥ng c√≥ ph·∫£n ·ª©ng'],
        correct: 0,
        explanation: 'T·∫°i cathode c·ªßa b√¨nh ƒëi·ªán ph√¢n, cation di chuy·ªÉn ƒë·∫øn v√† b·ªã kh·ª≠ (nh·∫≠n electron).'
      },
      {
        id: 7,
        type: 'true-false',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'ƒêi·ªán ph√¢n l√† qu√° tr√¨nh d√πng ƒëi·ªán nƒÉng ƒë·ªÉ th·ª±c hi·ªán ph·∫£n ·ª©ng oxi h√≥a - kh·ª≠ kh√¥ng t·ª± x·∫£y ra.',
        options: ['ƒê√∫ng', 'Sai'],
        correct: 0,
        explanation: 'ƒê√∫ng! ƒêi·ªán ph√¢n s·ª≠ d·ª•ng nƒÉng l∆∞·ª£ng ƒëi·ªán ƒë·ªÉ th√∫c ƒë·∫©y c√°c ph·∫£n ·ª©ng kh√¥ng t·ª± ph√°t.'
      },
      {
        id: 8,
        type: 'multiple',
        difficulty: 'nhan-biet',
        time: 15,
        question: 'Pin lithium-ion trong ƒëi·ªán tho·∫°i di ƒë·ªông ho·∫°t ƒë·ªông d·ª±a tr√™n nguy√™n t·∫Øc n√†o?',
        options: ['Pin ƒëi·ªán h√≥a', 'ƒêi·ªán ph√¢n', 'Nhi·ªát ƒëi·ªán', 'Quang ƒëi·ªán'],
        correct: 0,
        explanation: 'Pin ƒëi·ªán tho·∫°i l√† pin ƒëi·ªán h√≥a, chuy·ªÉn h√≥a nƒÉng l∆∞·ª£ng t·ª´ ph·∫£n ·ª©ng h√≥a h·ªçc th√†nh ƒëi·ªán nƒÉng.'
      },
      
      // TH√îNG HI·ªÇU (8 c√¢u) - 30 gi√¢y
      {
        id: 9,
        type: 'multiple',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'Trong pin Zn-Cu, k·∫Ωm ƒë√≥ng vai tr√≤ l√† anode v√¨:',
        options: ['Zn c√≥ t√≠nh kh·ª≠ m·∫°nh h∆°n Cu', 'Zn c√≥ t√≠nh oxi h√≥a m·∫°nh h∆°n Cu', 'Cu d·∫´n ƒëi·ªán t·ªët h∆°n', 'Cu r·∫ª h∆°n Zn'],
        correct: 0,
        explanation: 'Zn c√≥ t√≠nh kh·ª≠ m·∫°nh h∆°n Cu n√™n d·ªÖ nh∆∞·ªùng electron h∆°n, ƒë√≥ng vai tr√≤ anode (b·ªã oxi h√≥a).'
      },
      {
        id: 10,
        type: 'multiple',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'Khi pin Galvani ho·∫°t ƒë·ªông, kh·ªëi l∆∞·ª£ng ƒëi·ªán c·ª±c thay ƒë·ªïi nh∆∞ th·∫ø n√†o?',
        options: ['Anode gi·∫£m, cathode tƒÉng', 'Anode tƒÉng, cathode gi·∫£m', 'C·∫£ hai ƒë·ªÅu gi·∫£m', 'C·∫£ hai ƒë·ªÅu tƒÉng'],
        correct: 0,
        explanation: 'T·∫°i anode kim lo·∫°i b·ªã oxi h√≥a (tan ra) n√™n kh·ªëi l∆∞·ª£ng gi·∫£m; t·∫°i cathode ion kim lo·∫°i b·ªã kh·ª≠ (b√°m v√†o) n√™n kh·ªëi l∆∞·ª£ng tƒÉng.'
      },
      {
        id: 11,
        type: 'drag-drop',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'Gh√©p c√°c qu√° tr√¨nh v·ªõi ƒëi·ªán c·ª±c t∆∞∆°ng ·ª©ng trong pin ƒëi·ªán h√≥a:',
        pairs: [
          { item: 'Qu√° tr√¨nh oxi h√≥a', target: 'Anode' },
          { item: 'Qu√° tr√¨nh kh·ª≠', target: 'Cathode' },
          { item: 'Kim lo·∫°i tan ra', target: 'Anode' },
          { item: 'Ion kim lo·∫°i b√°m v√†o', target: 'Cathode' }
        ],
        explanation: 'Anode: oxi h√≥a, kim lo·∫°i tan. Cathode: kh·ª≠, ion kim lo·∫°i b√°m v√†o t·∫°o kim lo·∫°i.'
      },
      {
        id: 12,
        type: 'multiple',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'T·∫°i sao khi ƒëi·ªán ph√¢n dung d·ªãch NaCl kh√¥ng thu ƒë∆∞·ª£c Na ·ªü cathode?',
        options: ['H‚ÇÇO b·ªã kh·ª≠ tr∆∞·ªõc Na‚Å∫', 'Na tan trong n∆∞·ªõc', 'NaCl kh√¥ng ph√¢n li', 'D√≤ng ƒëi·ªán qu√° y·∫øu'],
        correct: 0,
        explanation: 'Trong dung d·ªãch, H‚ÇÇO d·ªÖ b·ªã kh·ª≠ h∆°n Na‚Å∫ n√™n t·∫°i cathode thu ƒë∆∞·ª£c H‚ÇÇ thay v√¨ Na.'
      },
      {
        id: 13,
        type: 'multiple',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'Su·∫•t ƒëi·ªán ƒë·ªông c·ªßa pin ph·ª• thu·ªôc v√†o y·∫øu t·ªë n√†o?',
        options: ['B·∫£n ch·∫•t kim lo·∫°i l√†m ƒëi·ªán c·ª±c', 'K√≠ch th∆∞·ªõc ƒëi·ªán c·ª±c', 'M√†u s·∫Øc ƒëi·ªán c·ª±c', 'H√¨nh d·∫°ng b√¨nh ch·ª©a'],
        correct: 0,
        explanation: 'Su·∫•t ƒëi·ªán ƒë·ªông ph·ª• thu·ªôc v√†o hi·ªáu th·∫ø ƒëi·ªán c·ª±c chu·∫©n c·ªßa hai kim lo·∫°i l√†m ƒëi·ªán c·ª±c.'
      },
      {
        id: 14,
        type: 'situation',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'M·ªôt h·ªçc sinh l√†m pin t·ª´ chanh v·ªõi ƒëi·ªán c·ª±c Zn v√† Cu. T·∫°i sao b√≥ng ƒë√®n LED c√≥ th·ªÉ s√°ng?',
        options: ['Ph·∫£n ·ª©ng oxi h√≥a kh·ª≠ t·∫°o d√≤ng ƒëi·ªán', 'Axit trong chanh ph√°t ƒëi·ªán', 'Cu t·ª± ph√°t s√°ng', 'Zn n√≥ng l√™n ph√°t ƒëi·ªán'],
        correct: 0,
        explanation: 'Zn b·ªã oxi h√≥a nh∆∞·ªùng electron, electron ch·∫°y qua d√¢y d·∫´n sang Cu l√†m ƒë√®n s√°ng. Axit trong chanh ƒë√≥ng vai tr√≤ dung d·ªãch ƒëi·ªán li.'
      },
      {
        id: 15,
        type: 'multiple',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'Trong b√¨nh ƒëi·ªán ph√¢n, d√≤ng ƒëi·ªán trong dung d·ªãch ƒë∆∞·ª£c t·∫°o b·ªüi:',
        options: ['S·ª± di chuy·ªÉn c·ªßa c√°c ion', 'S·ª± di chuy·ªÉn c·ªßa electron', 'S·ª± dao ƒë·ªông c·ªßa ph√¢n t·ª≠ n∆∞·ªõc', 'S·ª± bay h∆°i c·ªßa dung m√¥i'],
        correct: 0,
        explanation: 'Trong dung d·ªãch ƒëi·ªán ph√¢n, d√≤ng ƒëi·ªán l√† d√≤ng chuy·ªÉn d·ªùi c√≥ h∆∞·ªõng c·ªßa c√°c ion (cation v·ªÅ cathode, anion v·ªÅ anode).'
      },
      {
        id: 16,
        type: 'multiple',
        difficulty: 'thong-hieu',
        time: 30,
        question: 'M·∫° ƒëi·ªán d√πng ph∆∞∆°ng ph√°p n√†o?',
        options: ['ƒêi·ªán ph√¢n v·ªõi anode l√† kim lo·∫°i m·∫°', 'Pin ƒëi·ªán h√≥a', 'ƒêi·ªán ph√¢n n√≥ng ch·∫£y', 'Nhi·ªát luy·ªán'],
        correct: 0,
        explanation: 'M·∫° ƒëi·ªán d√πng ƒëi·ªán ph√¢n: v·∫≠t c·∫ßn m·∫° l√† cathode, kim lo·∫°i m·∫° l√† anode, dung d·ªãch ch·ª©a ion kim lo·∫°i m·∫°.'
      },
      
      // V·∫¨N D·ª§NG (4 c√¢u) - 120 gi√¢y
      {
        id: 17,
        type: 'calculation',
        difficulty: 'van-dung',
        time: 120,
        question: 'Pin Zn-Cu c√≥ E¬∞(Zn¬≤‚Å∫/Zn) = -0,76V v√† E¬∞(Cu¬≤‚Å∫/Cu) = +0,34V. Su·∫•t ƒëi·ªán ƒë·ªông chu·∫©n c·ªßa pin l√†:',
        options: ['1,10V', '0,42V', '-0,42V', '-1,10V'],
        correct: 0,
        explanation: 'E¬∞pin = E¬∞cathode - E¬∞anode = E¬∞(Cu¬≤‚Å∫/Cu) - E¬∞(Zn¬≤‚Å∫/Zn) = 0,34 - (-0,76) = 1,10V'
      },
      {
        id: 18,
        type: 'situation',
        difficulty: 'van-dung',
        time: 120,
        question: 'ƒê·ªÉ s·∫£n xu·∫•t nh√¥m c√¥ng nghi·ªáp, ng∆∞·ªùi ta ƒëi·ªán ph√¢n Al‚ÇÇO‚ÇÉ n√≥ng ch·∫£y thay v√¨ ƒëi·ªán ph√¢n dung d·ªãch AlCl‚ÇÉ. V√¨ sao?',
        options: ['ƒêi·ªán ph√¢n dung d·ªãch s·∫Ω thu ƒë∆∞·ª£c H‚ÇÇ thay v√¨ Al', 'AlCl‚ÇÉ kh√¥ng tan trong n∆∞·ªõc', 'Al‚ÇÇO‚ÇÉ r·∫ª h∆°n', 'ƒêi·ªán ph√¢n n√≥ng ch·∫£y nhanh h∆°n'],
        correct: 0,
        explanation: 'Trong dung d·ªãch, H‚ÇÇO d·ªÖ b·ªã kh·ª≠ h∆°n Al¬≥‚Å∫ n√™n t·∫°i cathode ch·ªâ thu ƒë∆∞·ª£c H‚ÇÇ. Ph·∫£i ƒëi·ªán ph√¢n n√≥ng ch·∫£y m·ªõi thu ƒë∆∞·ª£c Al.'
      },
      {
        id: 19,
        type: 'calculation',
        difficulty: 'van-dung',
        time: 120,
        question: 'Cho c√°c c·∫∑p oxi h√≥a - kh·ª≠: E¬∞(Ag‚Å∫/Ag) = +0,80V; E¬∞(Cu¬≤‚Å∫/Cu) = +0,34V; E¬∞(Zn¬≤‚Å∫/Zn) = -0,76V. Pin n√†o c√≥ su·∫•t ƒëi·ªán ƒë·ªông l·ªõn nh·∫•t?',
        options: ['Pin Zn-Ag', 'Pin Zn-Cu', 'Pin Cu-Ag', 'B·∫±ng nhau'],
        correct: 0,
        explanation: 'E¬∞(Zn-Ag) = 0,80 - (-0,76) = 1,56V > E¬∞(Zn-Cu) = 1,10V > E¬∞(Cu-Ag) = 0,46V'
      },
      {
        id: 20,
        type: 'situation',
        difficulty: 'van-dung',
        time: 120,
        question: 'Mu·ªën m·∫° b·∫°c l√™n chi·∫øc nh·∫´n ƒë·ªìng, c√°ch b·ªë tr√≠ n√†o ƒë√∫ng?',
        options: ['Nh·∫´n ƒë·ªìng l√† cathode, thanh b·∫°c l√† anode, dung d·ªãch AgNO‚ÇÉ', 'Nh·∫´n ƒë·ªìng l√† anode, thanh b·∫°c l√† cathode, dung d·ªãch AgNO‚ÇÉ', 'Nh·∫´n ƒë·ªìng l√† cathode, dung d·ªãch CuSO‚ÇÑ', 'Thanh b·∫°c l√† cathode, nh·∫´n ƒë·ªìng l√† anode'],
        correct: 0,
        explanation: 'V·∫≠t c·∫ßn m·∫° (nh·∫´n ƒë·ªìng) ph·∫£i l√† cathode ƒë·ªÉ ion Ag‚Å∫ b·ªã kh·ª≠ v√† b√°m l√™n. Anode l√† thanh b·∫°c ƒë·ªÉ b·ªï sung Ag‚Å∫ v√†o dung d·ªãch.'
      }
    ];
    
    // Game State
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let correctAnswers = 0;
    let timerInterval = null;
    let timeLeft = 0;
    let studentName = '';
    let studentClass = '';
    let gameStartTime = null;
    let allResults = [];
    let draggedItem = null;
    let dragDropAnswers = {};
    
    // Config
    const defaultConfig = {
      game_title: 'PIN ƒêI·ªÜN & ƒêI·ªÜN PH√ÇN',
      teacher_name: 'Nguy·ªÖn M·∫°nh H∆∞ng'
    };
    
    let config = { ...defaultConfig };
    
    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        allResults = data || [];
        if (document.getElementById('teacher-screen').classList.contains('hidden') === false) {
          renderResultsTable();
        }
      }
    };
    
    // Initialize
    async function initApp() {
      try {
        await window.dataSdk.init(dataHandler);
      } catch (e) {
        console.error('Data SDK init failed:', e);
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            updateUI();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['game_title', cfg.game_title || defaultConfig.game_title],
            ['teacher_name', cfg.teacher_name || defaultConfig.teacher_name]
          ])
        });
        config = { ...defaultConfig, ...window.elementSdk.config };
      }
      
      updateUI();
    }
    
    function updateUI() {
      document.getElementById('main-title').textContent = config.game_title || defaultConfig.game_title;
      document.getElementById('teacher-credit').innerHTML = `Thi·∫øt k·∫ø: <span class="font-semibold">${config.teacher_name || defaultConfig.teacher_name}</span>`;
    }
    
    // Shuffle array
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }
    
    // Shuffle options and track correct answer
    function shuffleQuestion(question) {
      if (question.type === 'drag-drop') return question;
      
      const shuffled = { ...question };
      const originalOptions = [...question.options];
      const correctOption = originalOptions[question.correct];
      
      shuffled.options = shuffleArray(originalOptions);
      shuffled.correct = shuffled.options.indexOf(correctOption);
      
      return shuffled;
    }
    
    // Start Game
    function startGame() {
      studentName = document.getElementById('student-name').value.trim();
      studentClass = document.getElementById('student-class').value.trim();
      
      if (!studentName || !studentClass) {
        showInlineError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† l·ªõp!');
        return;
      }
      
      // Shuffle questions and options
      currentQuestions = shuffleArray(allQuestions).map(q => shuffleQuestion(q));
      currentQuestionIndex = 0;
      score = 0;
      correctAnswers = 0;
      gameStartTime = new Date();
      
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      document.getElementById('player-name').textContent = studentName;
      
      loadQuestion();
    }
    
    function showInlineError(message) {
      const existingError = document.getElementById('inline-error');
      if (existingError) existingError.remove();
      
      const errorDiv = document.createElement('div');
      errorDiv.id = 'inline-error';
      errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4 animate-shake';
      errorDiv.textContent = message;
      
      const startBtn = document.getElementById('start-btn');
      startBtn.parentNode.insertBefore(errorDiv, startBtn);
      
      setTimeout(() => errorDiv.remove(), 3000);
    }
    
    // Load Question
    function loadQuestion() {
      const question = currentQuestions[currentQuestionIndex];
      
      // Update progress
      const progress = ((currentQuestionIndex) / currentQuestions.length) * 100;
      document.getElementById('progress-bar').style.width = `${progress}%`;
      document.getElementById('progress-text').textContent = `C√¢u ${currentQuestionIndex + 1}/${currentQuestions.length}`;
      document.getElementById('current-score').textContent = score;
      
      // Set difficulty badge
      const diffBadge = document.getElementById('difficulty-badge');
      if (question.difficulty === 'nhan-biet') {
        diffBadge.textContent = 'üìó Nh·∫≠n bi·∫øt';
        diffBadge.className = 'px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold';
      } else if (question.difficulty === 'thong-hieu') {
        diffBadge.textContent = 'üìò Th√¥ng hi·ªÉu';
        diffBadge.className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold';
      } else {
        diffBadge.textContent = 'üìï V·∫≠n d·ª•ng';
        diffBadge.className = 'px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-semibold';
      }
      
      // Set question type badge
      const typeBadge = document.getElementById('question-type-badge');
      const typeLabels = {
        'multiple': 'Tr·∫Øc nghi·ªám',
        'true-false': 'ƒê√∫ng/Sai',
        'drag-drop': 'K√©o th·∫£',
        'situation': 'T√¨nh hu·ªëng',
        'calculation': 'T√≠nh to√°n'
      };
      typeBadge.textContent = typeLabels[question.type] || 'Tr·∫Øc nghi·ªám';
      
      // Set question text
      document.getElementById('question-text').textContent = `C√¢u ${currentQuestionIndex + 1}: ${question.question}`;
      
      // Render options based on type
      const optionsContainer = document.getElementById('options-container');
      const dragDropContainer = document.getElementById('drag-drop-container');
      
      if (question.type === 'drag-drop') {
        optionsContainer.classList.add('hidden');
        dragDropContainer.classList.remove('hidden');
        renderDragDrop(question);
      } else {
        optionsContainer.classList.remove('hidden');
        dragDropContainer.classList.add('hidden');
        renderOptions(question);
      }
      
      // Start timer
      startTimer(question.time);
      
      // Animate card
      const card = document.getElementById('question-card');
      card.classList.remove('animate-slide-up');
      void card.offsetWidth;
      card.classList.add('animate-slide-up');
    }
    
    // Render Options
    function renderOptions(question) {
      const container = document.getElementById('options-container');
      const letters = ['A', 'B', 'C', 'D'];
      
      container.innerHTML = question.options.map((opt, idx) => `
        <button onclick="selectAnswer(${idx})" 
                class="option-btn w-full p-4 text-left bg-white border-2 border-gray-200 rounded-xl hover:border-indigo-400 hover:bg-indigo-50 transition flex items-center gap-3">
          <span class="w-10 h-10 flex items-center justify-center bg-indigo-100 text-indigo-700 font-bold rounded-full">${letters[idx]}</span>
          <span class="flex-1 text-gray-800">${opt}</span>
        </button>
      `).join('');
    }
    
    // Render Drag Drop
    function renderDragDrop(question) {
      dragDropAnswers = {};
      
      const items = shuffleArray(question.pairs.map(p => p.item));
      const targets = [...new Set(question.pairs.map(p => p.target))];
      
      document.getElementById('drag-items').innerHTML = items.map(item => `
        <div class="drag-item bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg font-semibold" 
             draggable="true" 
             ondragstart="dragStart(event, '${item}')"
             ondragend="dragEnd(event)">
          ${item}
        </div>
      `).join('');
      
      document.getElementById('drop-zones').innerHTML = targets.map(target => `
        <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
          <div class="font-bold text-gray-700 w-32">${target}:</div>
          <div class="drop-zone flex-1 min-h-12 border-2 border-dashed border-gray-300 rounded-lg p-2 flex flex-wrap gap-2"
               ondragover="dragOver(event)"
               ondragleave="dragLeave(event)"
               ondrop="drop(event, '${target}')"
               data-target="${target}">
          </div>
        </div>
      `).join('');
    }
    
    function dragStart(event, item) {
      draggedItem = item;
      event.target.classList.add('opacity-50');
    }
    
    function dragEnd(event) {
      event.target.classList.remove('opacity-50');
    }
    
    function dragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }
    
    function dragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }
    
    function drop(event, target) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');
      
      if (draggedItem) {
        // Remove from previous location
        Object.keys(dragDropAnswers).forEach(key => {
          if (dragDropAnswers[key].includes(draggedItem)) {
            dragDropAnswers[key] = dragDropAnswers[key].filter(i => i !== draggedItem);
          }
        });
        
        // Add to new location
        if (!dragDropAnswers[target]) dragDropAnswers[target] = [];
        dragDropAnswers[target].push(draggedItem);
        
        // Update display
        updateDropZones();
        
        // Remove from drag items
        const dragItems = document.getElementById('drag-items');
        const dragElements = dragItems.querySelectorAll('.drag-item');
        dragElements.forEach(el => {
          if (el.textContent.trim() === draggedItem) {
            el.style.display = 'none';
          }
        });
      }
      
      draggedItem = null;
    }
    
    function updateDropZones() {
      const zones = document.querySelectorAll('.drop-zone');
      zones.forEach(zone => {
        const target = zone.dataset.target;
        const items = dragDropAnswers[target] || [];
        zone.innerHTML = items.map(item => `
          <span class="bg-indigo-500 text-white px-3 py-1 rounded-lg text-sm cursor-pointer"
                onclick="removeFromZone('${item}', '${target}')">${item} ‚úï</span>
        `).join('');
      });
    }
    
    function removeFromZone(item, target) {
      dragDropAnswers[target] = dragDropAnswers[target].filter(i => i !== item);
      updateDropZones();
      
      // Show in drag items again
      const dragItems = document.getElementById('drag-items');
      const dragElements = dragItems.querySelectorAll('.drag-item');
      dragElements.forEach(el => {
        if (el.textContent.trim() === item) {
          el.style.display = 'block';
        }
      });
    }
    
    function submitDragDrop() {
      clearInterval(timerInterval);
      
      const question = currentQuestions[currentQuestionIndex];
      let correctCount = 0;
      
      question.pairs.forEach(pair => {
        if (dragDropAnswers[pair.target] && dragDropAnswers[pair.target].includes(pair.item)) {
          correctCount++;
        }
      });
      
      const isCorrect = correctCount === question.pairs.length;
      
      if (isCorrect) {
        score += 5;
        correctAnswers++;
      }
      
      showFeedback(isCorrect, question.explanation);
    }
    
    // Timer
    function startTimer(seconds) {
      clearInterval(timerInterval);
      timeLeft = seconds;
      
      const timerDisplay = document.getElementById('timer');
      timerDisplay.textContent = timeLeft;
      timerDisplay.parentElement.classList.remove('timer-warning');
      
      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.textContent = timeLeft;
        
        if (timeLeft <= 5) {
          timerDisplay.parentElement.classList.add('timer-warning');
          timerDisplay.classList.add('animate-timer-pulse');
        }
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          handleTimeout();
        }
      }, 1000);
    }
    
    function handleTimeout() {
      const question = currentQuestions[currentQuestionIndex];
      if (question.type === 'drag-drop') {
        submitDragDrop();
      } else {
        showFeedback(false, `H·∫øt gi·ªù! ${question.explanation}`);
      }
    }
    
    // Select Answer
    function selectAnswer(idx) {
      clearInterval(timerInterval);
      
      const question = currentQuestions[currentQuestionIndex];
      const isCorrect = idx === question.correct;
      
      // Highlight buttons
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach((btn, i) => {
        btn.disabled = true;
        if (i === question.correct) {
          btn.classList.add('bg-green-100', 'border-green-500');
          btn.querySelector('span:first-child').classList.add('bg-green-500', 'text-white');
        } else if (i === idx && !isCorrect) {
          btn.classList.add('bg-red-100', 'border-red-500', 'animate-shake');
          btn.querySelector('span:first-child').classList.add('bg-red-500', 'text-white');
        }
      });
      
      if (isCorrect) {
        score += 5;
        correctAnswers++;
      }
      
      setTimeout(() => {
        showFeedback(isCorrect, question.explanation);
      }, 500);
    }
    
    // Show Feedback
    function showFeedback(isCorrect, explanation) {
      const modal = document.getElementById('feedback-modal');
      const icon = document.getElementById('feedback-icon');
      const title = document.getElementById('feedback-title');
      const text = document.getElementById('feedback-text');
      const content = document.getElementById('feedback-content');
      
      if (isCorrect) {
        icon.textContent = 'üéâ';
        title.textContent = 'Ch√≠nh x√°c!';
        title.className = 'text-2xl font-bold mb-4 text-green-600';
        content.classList.add('border-4', 'border-green-400');
        content.classList.remove('border-red-400');
      } else {
        icon.textContent = 'üòÖ';
        title.textContent = 'Ch∆∞a ƒë√∫ng!';
        title.className = 'text-2xl font-bold mb-4 text-red-600';
        content.classList.add('border-4', 'border-red-400');
        content.classList.remove('border-green-400');
      }
      
      text.textContent = explanation;
      modal.classList.remove('hidden');
    }
    
    // Next Question
    function nextQuestion() {
      document.getElementById('feedback-modal').classList.add('hidden');
      currentQuestionIndex++;
      
      if (currentQuestionIndex >= currentQuestions.length) {
        endGame();
      } else {
        loadQuestion();
      }
    }
    
    // End Game
    async function endGame() {
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');
      
      const wrongAnswers = currentQuestions.length - correctAnswers;
      
      document.getElementById('final-score').textContent = score;
      document.getElementById('correct-count').textContent = correctAnswers;
      document.getElementById('wrong-count').textContent = wrongAnswers;
      document.getElementById('result-name').textContent = `${studentName} - ${studentClass}`;
      
      // Result message based on score
      let icon, title, message;
      if (score >= 90) {
        icon = 'üèÜ';
        title = 'Xu·∫•t s·∫Øc!';
        message = 'B·∫°n ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c v·ªÅ Pin ƒëi·ªán v√† ƒêi·ªán ph√¢n. Tuy·ªát v·ªùi!';
        createConfetti();
      } else if (score >= 70) {
        icon = 'üåü';
        title = 'Gi·ªèi l·∫Øm!';
        message = 'B·∫°n hi·ªÉu kh√° t·ªët v·ªÅ ch∆∞∆°ng n√†y. H√£y √¥n t·∫≠p th√™m ƒë·ªÉ ho√†n thi·ªán h∆°n nh√©!';
      } else if (score >= 50) {
        icon = 'üí™';
        title = 'Kh√° t·ªët!';
        message = 'B·∫°n ƒë√£ c√≥ n·ªÅn t·∫£ng c∆° b·∫£n. C·ªë g·∫Øng √¥n t·∫≠p th√™m ƒë·ªÉ c·∫£i thi·ªán ƒëi·ªÉm s·ªë!';
      } else {
        icon = 'üìö';
        title = 'C·∫ßn c·ªë g·∫Øng th√™m!';
        message = 'H√£y xem l·∫°i ki·∫øn th·ª©c ch∆∞∆°ng Pin ƒëi·ªán v√† ƒêi·ªán ph√¢n r·ªìi th·ª≠ l·∫°i nh√©!';
      }
      
      document.getElementById('result-icon').textContent = icon;
      document.getElementById('result-title').textContent = title;
      document.getElementById('result-message').textContent = message;
      
      // Save result
      const endTime = new Date();
      const duration = Math.round((endTime - gameStartTime) / 1000);
      const minutes = Math.floor(duration / 60);
      const seconds = duration % 60;
      
      if (allResults.length >= 999) {
        console.warn('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 k·∫øt qu·∫£');
        return;
      }
      
      try {
        const result = await window.dataSdk.create({
          student_name: studentName,
          student_class: studentClass,
          score: score,
          correct_answers: correctAnswers,
          total_questions: currentQuestions.length,
          completion_time: `${minutes}p ${seconds}s`,
          submitted_at: new Date().toISOString()
        });
        
        if (!result.isOk) {
          console.error('L∆∞u k·∫øt qu·∫£ th·∫•t b·∫°i');
        }
      } catch (e) {
        console.error('Error saving result:', e);
      }
    }
    
    function createConfetti() {
      const container = document.getElementById('result-confetti');
      const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];
      
      for (let i = 0; i < 30; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        piece.style.left = `${Math.random() * 100}%`;
        piece.style.animationDelay = `${Math.random() * 0.5}s`;
        piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        container.appendChild(piece);
      }
      
      setTimeout(() => container.innerHTML = '', 2000);
    }
    
    function restartGame() {
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      
      currentQuestions = shuffleArray(allQuestions).map(q => shuffleQuestion(q));
      currentQuestionIndex = 0;
      score = 0;
      correctAnswers = 0;
      gameStartTime = new Date();
      
      loadQuestion();
    }
    
    function goHome() {
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('teacher-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
    }
    
    // Teacher Results
    function showResults() {
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('teacher-screen').classList.remove('hidden');
      renderResultsTable();
    }
    
    function renderResultsTable() {
      const tbody = document.getElementById('results-table');
      
      if (!allResults || allResults.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
              Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o
            </td>
          </tr>
        `;
        document.getElementById('total-students').textContent = '0';
        document.getElementById('avg-score').textContent = '0';
        document.getElementById('highest-score').textContent = '0';
        return;
      }
      
      // Sort by time (newest first)
      const sortedResults = [...allResults].sort((a, b) => 
        new Date(b.submitted_at) - new Date(a.submitted_at)
      );
      
      // Calculate stats
      const totalStudents = sortedResults.length;
      const avgScore = Math.round(sortedResults.reduce((sum, r) => sum + (r.score || 0), 0) / totalStudents);
      const highestScore = Math.max(...sortedResults.map(r => r.score || 0));
      
      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('avg-score').textContent = avgScore;
      document.getElementById('highest-score').textContent = highestScore;
      
      tbody.innerHTML = sortedResults.map((result, idx) => {
        const date = result.submitted_at ? new Date(result.submitted_at) : new Date();
        const dateStr = date.toLocaleDateString('vi-VN');
        const timeStr = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        
        const scoreClass = (result.score || 0) >= 70 ? 'text-green-600' : (result.score || 0) >= 50 ? 'text-yellow-600' : 'text-red-600';
        
        return `
          <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
            <td class="px-4 py-3">${idx + 1}</td>
            <td class="px-4 py-3 font-semibold">${result.student_name || 'N/A'}</td>
            <td class="px-4 py-3">${result.student_class || 'N/A'}</td>
            <td class="px-4 py-3 text-center font-bold ${scoreClass}">${result.score || 0}</td>
            <td class="px-4 py-3 text-center">${result.correct_answers || 0}/${result.total_questions || 20}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${dateStr} ${timeStr}<br><span class="text-xs">${result.completion_time || ''}</span></td>
          </tr>
        `;
      }).join('');
    }
    
    function downloadResults() {
      if (!allResults || allResults.length === 0) {
        showDownloadMessage('Ch∆∞a c√≥ k·∫øt qu·∫£ ƒë·ªÉ t·∫£i xu·ªëng');
        return;
      }
      
      const headers = ['STT', 'H·ªç v√† t√™n', 'L·ªõp', 'ƒêi·ªÉm', 'S·ªë c√¢u ƒë√∫ng', 'T·ªïng c√¢u', 'Th·ªùi gian l√†m b√†i', 'Th·ªùi ƒëi·ªÉm n·ªôp'];
      
      const rows = allResults.map((r, idx) => {
        const date = r.submitted_at ? new Date(r.submitted_at) : new Date();
        return [
          idx + 1,
          r.student_name || '',
          r.student_class || '',
          r.score || 0,
          r.correct_answers || 0,
          r.total_questions || 20,
          r.completion_time || '',
          date.toLocaleString('vi-VN')
        ];
      });
      
      // BOM for UTF-8
      let csv = '\uFEFF' + headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `ket_qua_pin_dien_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
      
      showDownloadMessage('ƒê√£ t·∫£i xu·ªëng th√†nh c√¥ng!');
    }
    
    function showDownloadMessage(message) {
      const existingMsg = document.getElementById('download-msg');
      if (existingMsg) existingMsg.remove();
      
      const msgDiv = document.createElement('div');
      msgDiv.id = 'download-msg';
      msgDiv.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg animate-slide-up';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      
      setTimeout(() => msgDiv.remove(), 3000);
    }
    
    // Initialize on load
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c8992b891100aa5',t:'MTc3MDIwMTg3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>